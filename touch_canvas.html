<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mode Pilih Elemen Berfungsi</title>
<style>
  body { font-family:"Poppins",sans-serif; background:linear-gradient(135deg,#e3f2fd,#f3f5f7); margin:0; padding:0; display:flex; flex-direction:column; align-items:center; min-height:100vh; }
  h2 { color:#2a4d8f; margin-top:50px; text-align:center; }
  #controls { margin:10px; display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
  button, select { padding:8px 12px; border-radius:8px; border:1px solid #ccc; background:#fff; cursor:pointer; }
  button.active { background:#4a90e2; color:white; border-color:#3578d3; }
  #canvasWrapper { width:100%; max-width:1200px; display:flex; gap:20px; flex-wrap:wrap; justify-content:center; align-items:flex-start; }
  #canvasArea { position:relative; width:65%; min-width:320px; height:480px; border:2px solid #ccc; border-radius:12px; overflow:hidden; background:white; }
  canvas { position:absolute; top:0; left:0; width:100%; height:100%; touch-action:none; user-select:none; z-index:5; }
  #elements-layer { position:absolute; top:0; left:0; width:100%; height:100%; z-index:10; pointer-events:auto; }
  .resizable { position:absolute; touch-action:none; user-select:none; display:block; }
  .resizable img { width:100%; height:100%; object-fit:contain; pointer-events:none; }
  #canvasKunci { width:30%; min-width:220px; border:2px dashed #aaa; border-radius:12px; padding:10px; background:#fafafa; display:none; text-align:center; }
  #canvasKunci img { width:100%; height:auto; object-fit:contain; border-radius:8px; }
  #elemenList { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:12px; width:100%; max-width:1200px; }
  .elemen { width:90px; height:90px; border:2px solid #ccc; border-radius:8px; display:flex; align-items:center; justify-content:center; background:#fff; cursor:pointer; }
  .elemen img { width:80%; height:80%; object-fit:contain; }
  .note { background:#e3f2fd; color:#2a4d8f; padding:6px 10px; border-radius:8px; font-size:14px; margin-top:12px; }
</style>
</head>
<body>

<h2>üß∞ Media Pembelajaran: Merangkai Elemen Setrika Listrik (Touch)</h2>

<div id="controls">
  <button id="modeDraw">‚úèÔ∏è Mode Gambar</button>
  <button id="modeDrag" class="active">üñêÔ∏è Mode Elemen</button>
  <button id="toggleKunci">üëÅÔ∏è Tampilkan Kunci Jawaban</button>
  <button id="clearCanvas">üßπ Hapus Gambar & Elemen</button>
  <select id="selWidth"><option value="6">6</option><option value="9" selected>9</option><option value="12">12</option><option value="15">15</option></select>
  <select id="selColor"><option value="black">Hitam</option><option value="blue" selected>Biru</option><option value="red">Merah</option><option value="green">Hijau</option><option value="yellow">Kuning</option><option value="gray">Abu</option></select>
</div>

<div id="canvasWrapper">
  <div id="canvasArea">
    <canvas id="drawCanvas"></canvas>
    <div id="elements-layer"></div>
  </div>
  <div id="canvasKunci">
    <h3>üîç Susunan Benar</h3>
    <img src="assets/kunciJawaban.png" alt="Kunci Jawaban" />
  </div>
</div>

<div class="note">üí° Tekan lama elemen di kanvas untuk menghapusnya. Gunakan dua jari untuk memperbesar/memperkecil.</div>

<h4 style="margin-top:16px">üé® Elemen Setrika</h4>
<div id="elemenList">
  <div class="elemen"><img src="assets/titikA.png" alt="A" /></div>
  <div class="elemen"><img src="assets/titikB.png" alt="B" /></div>
  <div class="elemen"><img src="assets/titikC.png" alt="C" /></div>
  <div class="elemen"><img src="assets/titikD.png" alt="D" /></div>
  <div class="elemen"><img src="assets/titikE.png" alt="E" /></div>
</div>

<script>
const drawCanvas = document.getElementById("drawCanvas");
const ctx = drawCanvas.getContext("2d");
const elementsLayer = document.getElementById("elements-layer");
let mode = "drag";
let ongoingTouches = [];

/* === Setup ukuran canvas === */
function resizeCanvas(){
  const rect = drawCanvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  drawCanvas.width = rect.width * dpr;
  drawCanvas.height = rect.height * dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.lineCap = "round";
  ctx.lineJoin = "round";
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

/* === Tombol Mode === */
function setMode(m){
  mode = m;
  document.getElementById("modeDraw").classList.toggle("active", m==="draw");
  document.getElementById("modeDrag").classList.toggle("active", m==="drag");
  drawCanvas.style.pointerEvents = (m==="draw") ? "auto" : "none";
  elementsLayer.style.pointerEvents = (m==="drag") ? "auto" : "none";
}
document.getElementById("modeDraw").addEventListener("click", ()=> setMode("draw"));
document.getElementById("modeDrag").addEventListener("click", ()=> setMode("drag"));

/* === Toggle kunci jawaban === */
document.getElementById("toggleKunci").addEventListener("click", ()=>{
  const kunci = document.getElementById("canvasKunci");
  const visible = kunci.style.display==="block";
  kunci.style.display = visible ? "none" : "block";
});

/* === Hapus semua === */
document.getElementById("clearCanvas").addEventListener("click", ()=>{
  ctx.clearRect(0,0,drawCanvas.width,drawCanvas.height);
  elementsLayer.innerHTML = "";
});

/* === Gambar (mode draw) === */
function copyTouch(t){ return {identifier:t.identifier, clientX:t.clientX, clientY:t.clientY}; }
function idxById(id){ return ongoingTouches.findIndex(t=>t.identifier===id); }

drawCanvas.addEventListener("touchstart", e=>{
  if(mode!=="draw") return;
  e.preventDefault();
  ongoingTouches = Array.from(e.changedTouches).map(copyTouch);
},{passive:false});

drawCanvas.addEventListener("touchmove", e=>{
  if(mode!=="draw") return;
  e.preventDefault();
  const rect = drawCanvas.getBoundingClientRect();
  for(const touch of e.changedTouches){
    const idx = idxById(touch.identifier);
    if(idx>=0){
      const prev = ongoingTouches[idx];
      ctx.beginPath();
      ctx.moveTo(prev.clientX - rect.left, prev.clientY - rect.top);
      ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
      ctx.lineWidth = parseFloat(document.getElementById("selWidth").value);
      ctx.strokeStyle = document.getElementById("selColor").value;
      ctx.stroke();
      ongoingTouches[idx] = copyTouch(touch);
    }
  }
},{passive:false});

drawCanvas.addEventListener("touchend", ()=> ongoingTouches=[], {passive:false});
drawCanvas.addEventListener("touchcancel", ()=> ongoingTouches=[], {passive:false});

/* === DRAG & DROP + RESIZE (TOUCH) === */

document.querySelectorAll(".elemen").forEach(el => {
  el.addEventListener("touchstart", e => {
    if (mode !== "drag") return;
    e.preventDefault();

    const imgSrc = el.querySelector("img").src;

    const newEl = document.createElement("div");
    newEl.className = "resizable";
    newEl.style.left = "50px";
    newEl.style.top = "50px";
    newEl.style.width = "100px";
    newEl.style.height = "100px";

    const img = document.createElement("img");
    img.src = imgSrc;
    newEl.appendChild(img);

    elementsLayer.appendChild(newEl);

    initTouchDragZoom(newEl);
  });
});

function initTouchDragZoom(el) {
  let lastDist = null;
  let startX = 0, startY = 0;
  let moving = false;
  let longPressTimer = null;

  el.addEventListener("touchstart", e => {
    if (e.touches.length === 1) {
      moving = true;
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;

      longPressTimer = setTimeout(() => {
        moving = false;
        if (confirm("Hapus elemen ini?")) el.remove();
      }, 1000);

    } else if (e.touches.length === 2) {
      moving = false;
      lastDist = getDistance(e.touches);
      clearTimeout(longPressTimer);
    }
  }, { passive: false });

  el.addEventListener("touchmove", e => {
    e.preventDefault();
    clearTimeout(longPressTimer);

    if (e.touches.length === 1 && moving) {
      const dx = e.touches[0].clientX - startX;
      const dy = e.touches[0].clientY - startY;
      el.style.left = el.offsetLeft + dx + "px";
      el.style.top = el.offsetTop + dy + "px";
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
    } else if (e.touches.length === 2) {
      const newDist = getDistance(e.touches);
      const scale = newDist / lastDist;
      el.style.width = el.offsetWidth * scale + "px";
      el.style.height = el.offsetHeight * scale + "px";
      lastDist = newDist;
    }
  }, { passive: false });

  el.addEventListener("touchend", e => {
    moving = false;
    lastDist = null;
    clearTimeout(longPressTimer);
  });
}

function getDistance(touches) {
  const dx = touches[0].clientX - touches[1].clientX;
  const dy = touches[0].clientY - touches[1].clientY;
  return Math.sqrt(dx * dx + dy * dy);
}
</script>
</body>
</html>
