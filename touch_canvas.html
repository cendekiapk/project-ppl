<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Media Interaktif - Setrika (Touch Only)</title>
<style>
  body {
    font-family: "Poppins", sans-serif;
    background: linear-gradient(135deg, #e3f2fd, #f3f5f7);
    margin: 0; padding: 0;
    display: flex; flex-direction: column; align-items: center;
    min-height: 100vh;
  }

  #btnBack {
    position: absolute; top: 15px; left: 15px;
    background: #4a90e2; color: white;
    border: none; border-radius: 50%;
    width: 48px; height: 48px;
    font-size: 22px; display: flex; align-items: center; justify-content: center;
    cursor: pointer; box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    z-index: 999; transition: 0.3s;
  }
  #btnBack:hover { background: #3578d3; transform: scale(1.05); }

  h2 { text-align: center; margin-top: 70px; color: #2a4d8f; }

  #controls {
    display: flex; gap: 10px; flex-wrap: wrap;
    justify-content: center; margin: 10px 0;
  }
  #controls button, #controls select {
    padding: 8px 14px;
    border: none; border-radius: 6px;
    background: #e0e0e0;
    cursor: pointer; font-size: 15px; transition: 0.2s;
  }
  #controls button.active { background: #4a90e2; color: white; }

  #canvasWrapper {
    display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;
    width: 100%; max-width: 1200px;
  }
  #canvasArea {
    position: relative;
    width: 65%; height: 500px;
    border: 2px solid #ccc; border-radius: 12px;
    background: transparent; overflow: hidden;
  }
  #drawCanvas {
    position: absolute; top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 4; background: transparent;
    touch-action: none;
  }
  #elements-layer {
    position: absolute; top: 0; left: 0;
    width: 100%; height: 100%; z-index: 5;
  }

  #canvasKunci {
    width: 30%;
    border: 2px dashed #aaa;
    border-radius: 12px;
    padding: 10px;
    background: #fafafa;
    text-align: center;
    display: none;
  }
  #canvasKunci img {
    width: 100%; max-height: 480px;
    object-fit: contain; border-radius: 8px;
  }

  .elemen {
    width: 90px; height: 90px;
    border: 2px solid #ccc; border-radius: 8px;
    background: white; display: flex;
    align-items: center; justify-content: center;
    cursor: grab;
  }
  .elemen img { width: 80%; height: 80%; object-fit: contain; }

  .resizable {
    position: absolute;
    border: none;
    background: transparent;
    touch-action: none;
  }
  .resizable img {
    width: 100%; height: 100%;
    object-fit: contain; pointer-events: none;
  }

  #elemenList {
    display: flex; justify-content: center;
    gap: 10px; flex-wrap: wrap; margin-top: 10px;
  }
</style>
</head>
<body>
<button id="btnBack" onclick="window.location.href='index.html'">‚¨ÖÔ∏è</button>

<h2>üß∞ Media Pembelajaran: Merangkai Elemen Setrika Listrik (Touch)</h2>

<div id="controls">
  <button id="modeDraw">‚úèÔ∏è Mode Gambar</button>
  <button id="modeDrag" class="active">üñêÔ∏è Mode Elemen</button>
  <button id="toggleKunci">üëÅÔ∏è Tampilkan Kunci Jawaban</button>
  <button id="clearCanvas">üßπ Hapus Gambar</button>
  <div style="text-align: center; background: #e3f2fd; color: #2a4d8f; font-size: 14px;
              padding: 6px 10px; border-radius: 8px; margin-top: 10px; width: fit-content;">
    üí° Tekan lama elemen di kanvas untuk menghapusnya.
  </div>
  <select id="selWidth">
    <option value="6">6</option>
    <option value="9" selected>9</option>
    <option value="12">12</option>
    <option value="15">15</option>
  </select>
  <select id="selColor">
    <option value="black">Hitam</option>
    <option value="blue" selected>Biru</option>
    <option value="red">Merah</option>
    <option value="green">Hijau</option>
    <option value="yellow">Kuning</option>
    <option value="gray">Abu</option>
  </select>
</div>

<div id="canvasWrapper">
  <div id="canvasArea">
    <canvas id="drawCanvas"></canvas>
    <div id="elements-layer"></div>
  </div>

  <div id="canvasKunci">
    <h3>üîç Susunan Benar</h3>
    <img src="assets/kunciJawaban.png" alt="Kunci Jawaban" />
  </div>
</div>

<h4>üé® Elemen Setrika</h4>
<div id="elemenList">
  <div class="elemen"><img src="assets/titikA.png" alt="A" /></div>
  <div class="elemen"><img src="assets/titikB.png" alt="B" /></div>
  <div class="elemen"><img src="assets/titikC.png" alt="C" /></div>
  <div class="elemen"><img src="assets/titikD.png" alt="D" /></div>
  <div class="elemen"><img src="assets/titikE.png" alt="E" /></div>
</div>

<script>
const drawCanvas = document.getElementById("drawCanvas");
const ctx = drawCanvas.getContext("2d");
const canvasArea = document.getElementById("canvasArea");
const elementsLayer = document.getElementById("elements-layer");
const btnDraw = document.getElementById("modeDraw");
const btnDrag = document.getElementById("modeDrag");
const btnKunci = document.getElementById("toggleKunci");
const divKunci = document.getElementById("canvasKunci");
const btnClear = document.getElementById("clearCanvas");

let mode = "drag";
let ongoingTouches = [];
let offsetX, offsetY;

// resize canvas to fit
function resizeCanvas() {
  drawCanvas.width = canvasArea.clientWidth;
  drawCanvas.height = canvasArea.clientHeight;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

function setMode(m) {
  mode = m;
  btnDraw.classList.toggle("active", m === "draw");
  btnDrag.classList.toggle("active", m === "drag");
  drawCanvas.style.pointerEvents = (m === "draw") ? "auto" : "none";
}
btnDraw.addEventListener("click", () => setMode("draw"));
btnDrag.addEventListener("click", () => setMode("drag"));

btnKunci.addEventListener("click", () => {
  const visible = divKunci.style.display === "block";
  divKunci.style.display = visible ? "none" : "block";
  btnKunci.textContent = visible ? "üëÅÔ∏è Tampilkan Kunci Jawaban" : "üôà Sembunyikan Kunci Jawaban";
});

btnClear.addEventListener("click", () => {
  ctx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
});

// --- DRAW MODE ---
drawCanvas.addEventListener('touchstart', handleStart, { passive: false });
drawCanvas.addEventListener('touchend', handleEnd, { passive: false });
drawCanvas.addEventListener('touchcancel', handleCancel, { passive: false });
drawCanvas.addEventListener('touchmove', handleMove, { passive: false });

function handleStart(evt) {
  if (mode !== "draw") return;
  evt.preventDefault();
  const touches = evt.changedTouches;
  offsetX = drawCanvas.getBoundingClientRect().left;
  offsetY = drawCanvas.getBoundingClientRect().top;
  for (let i = 0; i < touches.length; i++) ongoingTouches.push(copyTouch(touches[i]));
}
function handleMove(evt) {
  if (mode !== "draw") return;
  evt.preventDefault();
  const touches = evt.changedTouches;
  for (let i = 0; i < touches.length; i++) {
    const color = document.getElementById('selColor').value;
    const idx = ongoingTouchIndexById(touches[i].identifier);
    if (idx >= 0) {
      ctx.beginPath();
      ctx.moveTo(ongoingTouches[idx].clientX - offsetX, ongoingTouches[idx].clientY - offsetY);
      ctx.lineTo(touches[i].clientX - offsetX, touches[i].clientY - offsetY);
      ctx.lineWidth = document.getElementById('selWidth').value;
      ctx.strokeStyle = color;
      ctx.lineJoin = "round";
      ctx.closePath();
      ctx.stroke();
      ongoingTouches.splice(idx, 1, copyTouch(touches[i]));
    }
  }
}
function handleEnd(evt) {
  if (mode !== "draw") return;
  evt.preventDefault();
  const touches = evt.changedTouches;
  for (let i = 0; i < touches.length; i++) {
    let idx = ongoingTouchIndexById(touches[i].identifier);
    if (idx >= 0) ongoingTouches.splice(idx, 1);
  }
}
function handleCancel(evt) {
  evt.preventDefault();
  const touches = evt.changedTouches;
  for (let i = 0; i < touches.length; i++) {
    let idx = ongoingTouchIndexById(touches[i].identifier);
    ongoingTouches.splice(idx, 1);
  }
}
function copyTouch({ identifier, clientX, clientY }) {
  return { identifier, clientX, clientY };
}
function ongoingTouchIndexById(idToFind) {
  for (let i = 0; i < ongoingTouches.length; i++) {
    const id = ongoingTouches[i].identifier;
    if (id === idToFind) return i;
  }
  return -1;
}

// --- DRAG & PINCH ---
document.querySelectorAll(".elemen").forEach(el => {
  el.addEventListener("touchstart", e => {
    if (mode !== "drag") return;
    e.preventDefault();
    const imgSrc = el.querySelector("img").src;
    const newEl = document.createElement("div");
    newEl.className = "resizable";
    newEl.style.left = "50px";
    newEl.style.top = "50px";
    newEl.style.width = "100px";
    newEl.style.height = "100px";
    const img = document.createElement("img");
    img.src = imgSrc;
    newEl.appendChild(img);
    elementsLayer.appendChild(newEl);
    initTouchDragZoom(newEl);
  });
});

function initTouchDragZoom(el) {
  let lastDist = null, startX = 0, startY = 0, moving = false;
  let longPressTimer = null;

  el.addEventListener("touchstart", e => {
    if (e.touches.length === 1) {
      moving = true;
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
      longPressTimer = setTimeout(() => {
        moving = false;
        if (confirm("Hapus elemen ini?")) el.remove();
      }, 900);
    } else if (e.touches.length === 2) {
      moving = false;
      lastDist = getDistance(e.touches);
      clearTimeout(longPressTimer);
    }
  }, { passive: false });

  el.addEventListener("touchmove", e => {
    e.preventDefault();
    clearTimeout(longPressTimer);
    if (e.touches.length === 1 && moving) {
      const dx = e.touches[0].clientX - startX;
      const dy = e.touches[0].clientY - startY;
      el.style.left = el.offsetLeft + dx + "px";
      el.style.top = el.offsetTop + dy + "px";
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
    } else if (e.touches.length === 2) {
      const newDist = getDistance(e.touches);
      const scale = newDist / lastDist;
      el.style.width = el.offsetWidth * scale + "px";
      el.style.height = el.offsetHeight * scale + "px";
      lastDist = newDist;
    }
  }, { passive: false });

  el.addEventListener("touchend", e => {
    moving = false;
    lastDist = null;
    clearTimeout(longPressTimer);
  });
}

function getDistance(touches) {
  const dx = touches[0].clientX - touches[1].clientX;
  const dy = touches[0].clientY - touches[1].clientY;
  return Math.sqrt(dx * dx + dy * dy);
}
</script>
</body>
</html>
