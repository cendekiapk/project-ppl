<script>
const canvasArea = document.getElementById("canvas");
const drawCanvas = document.getElementById("drawCanvas");
const ctx = drawCanvas.getContext("2d");
const elementsLayer = document.getElementById("elements-layer");
const petunjuk = document.getElementById("petunjuk");
const divKunci = document.getElementById("canvasKunci");

// âœ… Set ukuran CANVAS sesuai ukuran div
function resizeCanvas() {
  drawCanvas.width = canvasArea.clientWidth;
  drawCanvas.height = canvasArea.clientHeight;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

let mode = "elemen";
let drawing = false, startX, startY;
let currentColor = "#2a4d8f", currentSize = 3;
let lines = [];

const btnDraw = document.getElementById("modeDraw");
const btnElemen = document.getElementById("modeClick");
const btnUndo = document.getElementById("undo");
const btnKunci = document.getElementById("toggleKunci");

btnDraw.onclick = () => setMode("draw");
btnElemen.onclick = () => setMode("elemen");
btnUndo.onclick = () => { 
  if (lines.length > 0) {
    lines.pop(); 
    redrawAll(); 
  }
};
btnKunci.onclick = () => {
  divKunci.style.display = divKunci.style.display === "none" || divKunci.style.display === "" ? "block" : "none";
  btnKunci.textContent = divKunci.style.display === "block" ? "ðŸ™ˆ Sembunyikan Kunci Jawaban" : "ðŸ‘ï¸ Tampilkan Kunci Jawaban";
};

function setMode(m) {
  mode = m;
  btnDraw.classList.toggle("active", m === "draw");
  btnElemen.classList.toggle("active", m === "elemen");
  drawCanvas.style.pointerEvents = (m === "draw") ? "auto" : "none";
}

function getTouchPos(e) {
  const rect = drawCanvas.getBoundingClientRect();
  const t = e.touches[0];
  return { x: t.clientX - rect.left, y: t.clientY - rect.top };
}

// âœ… Gunakan { passive:false } agar touchmove tidak diblok
drawCanvas.addEventListener("touchstart", e => {
  if (mode !== "draw" || e.touches.length > 1) return;
  e.preventDefault();
  const pos = getTouchPos(e);
  drawing = true;
  startX = pos.x; 
  startY = pos.y;
}, { passive: false });

drawCanvas.addEventListener("touchmove", e => {
  if (!drawing || mode !== "draw" || e.touches.length > 1) return;
  e.preventDefault();
  const pos = getTouchPos(e);
  ctx.beginPath();
  ctx.moveTo(startX, startY);
  ctx.lineTo(pos.x, pos.y);
  ctx.strokeStyle = currentColor;
  ctx.lineWidth = currentSize;
  ctx.lineCap = "round";
  ctx.lineJoin = "round";
  ctx.stroke();
  startX = pos.x; 
  startY = pos.y;
}, { passive: false });

drawCanvas.addEventListener("touchend", e => {
  if (mode === "draw") {
    drawing = false;
    lines.push(ctx.getImageData(0, 0, drawCanvas.width, drawCanvas.height));
  }
}, { passive: false });

function redrawAll() {
  ctx.clearRect(0,0,drawCanvas.width, drawCanvas.height);
  for (let snap of lines) ctx.putImageData(snap,0,0);
}

// --- Fitur drag/drop elemen ---
document.querySelectorAll(".elemen").forEach(el => {
  el.addEventListener("touchstart", e => { if(e.touches.length>1) return; e.preventDefault(); });
  el.addEventListener("touchend", e => {
    if(e.changedTouches.length>1) return;
    e.preventDefault();
    const rect = elementsLayer.getBoundingClientRect();
    const x = e.changedTouches[0].clientX - rect.left - el.offsetWidth/2;
    const y = e.changedTouches[0].clientY - rect.top - el.offsetHeight/2;
    petunjuk.style.display = "none";
    createDrop(el,x,y);
  });
});

function createDrop(el,x,y){
  const clone = document.createElement("div");
  clone.className="resizable";
  clone.style.left=x+"px";
  clone.style.top=y+"px";
  clone.style.width="100px";
  clone.style.height="100px";
  const img=document.createElement("img");
  img.src=el.querySelector("img").src;
  clone.appendChild(img);
  const handle=document.createElement("div");
  handle.className="resize-handle";
  clone.appendChild(handle);
  elementsLayer.appendChild(clone);
  makeDraggable(clone);
  makeResizable(clone,handle);
}

function makeDraggable(el){
  let dragging=false, ox, oy;
  el.addEventListener("touchstart", e => {
    if(e.touches.length>1) return;
    if(e.target.classList.contains("resize-handle")) return;
    e.preventDefault();
    const t=e.touches[0];
    dragging=true;
    ox=t.clientX-el.offsetLeft;
    oy=t.clientY-el.offsetTop;
  }, { passive:false });

  document.addEventListener("touchmove", e => {
    if(!dragging) return;
    e.preventDefault();
    const t=e.touches[0];
    el.style.left=t.clientX-ox+"px";
    el.style.top=t.clientY-oy+"px";
  }, { passive:false });

  document.addEventListener("touchend", ()=>dragging=false, { passive:false });
}

function makeResizable(el, handle){
  let resizing=false, sx, sy, sw, sh;
  handle.addEventListener("touchstart", e=>{
    if(e.touches.length>1) return;
    e.preventDefault();
    const t=e.touches[0];
    resizing=true;
    sx=t.clientX; sy=t.clientY;
    sw=el.offsetWidth; sh=el.offsetHeight;
  }, { passive:false });

  document.addEventListener("touchmove", e=>{
    if(!resizing) return;
    e.preventDefault();
    const t=e.touches[0];
    el.style.width=Math.max(60, sw+t.clientX-sx)+"px";
    el.style.height=Math.max(60, sh+t.clientY-sy)+"px";
  }, { passive:false });

  document.addEventListener("touchend", ()=>resizing=false, { passive:false });
}

setMode("elemen");
</script>
